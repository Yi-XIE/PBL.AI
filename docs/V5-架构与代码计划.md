# V5 架构与代码计划（入口准确性 & 反向补全一致性加强版）

本计划基于 `docs/重构指南-架构.md` 与 `docs/005.md` 的升级建议，聚焦：  
1) **双入口判断准确性**（scenario / tool_seed）  
2) **反向补全逻辑一致性**  
3) **四层上下文 + 双模式对话**  
4) **低延迟生成（不含预测式预生成）**  
5) **场景强制现实化**（拒绝魔法/科幻）

---

## 1. 核心原则（不可违背）
1. 双入口是系统精髓：`scenario` 与 `tool_seed`。  
2. 反向补全必须“解释 → 建议 → 用户确认”，**不得隐式推进**。  
3. 流程与状态由引擎管理，LLM 只负责生成与解释。  
4. 场景必须贴近真实生活或真实学习任务，禁止魔法/科幻/超现实设定。  
5. **取消预测式预生成**（节省 token）。

---

## 2. 目标与范围
- 入口判断准确率提升、可解释、可追溯。  
- 反向补全逻辑一致、可复盘、无隐式推进。  
- 四层上下文与双模式对话落地。  
- 候选生成低延迟（异步 + 可选流式结构化输出）。  
- 如启用 LangSmith：完整追踪对话与生成链路。  

---

## 3. 入口判断准确性（重点计划）
### 3.1 信号与权重
**强信号（直接匹配）**
- “从场景开始/从情境开始” → `scenario`  
- “从工具/实验/活动/驱动问题开始” → `tool_seed`

**中信号（关键词）**
- `tool_seed`：工具名/实验/活动/驱动问题/项目任务  
- `scenario`：情境/生活问题/真实任务描述  

**兜底**
- LLM 入口分类 + 理由 + 置信度（0~1）

### 3.2 判定输出（可追溯）
在 Decision/Message 中记录：
- `chosen_entry_point`  
- `rules_hit` / `model_reason`  
- `confidence`

### 3.3 低置信度处理
- 置信度 < 阈值必须发起澄清问题  
- 禁止隐式推进  

---

## 4. 反向补全一致性（重点计划）
### 4.1 一致性规则
1. 依赖缺失时先解释再建议，不自动生成缺失阶段。  
2. `iteration_count` 仅在完整“用户决策循环”结束时 +1。  
3. regenerate 后清理旧冲突或重新计算冲突。  
4. 统一依赖链：`scenario → driving_question → question_chain → activity → experiment`  
5. 选择后冻结其他候选，不跨 Stage 回退。  

### 4.2 技术落点
- 依赖检查统一由 `engine.dependency_check` 输出  
- `require_previous` 文案保持一致  
- `decision_history` 记录每次补全过程与用户确认  

---

## 5. 场景现实性约束（必须落地）
### 5.1 Prompt 约束
- 强制使用真实生活场景或真实学习任务  
- 明确禁止：魔法、科幻、超现实设定  

### 5.2 输出过滤
- 命中“魔法/穿越/外星/超能力/科幻”等关键词直接拒绝并重生成  
- 记录警告或冲突原因（可选）  

---

## 6. 四层上下文与双模式对话（来自 005）
### 6.1 四层上下文
- Layer 4: Creative Intent（最高权重、不可覆盖）  
- Layer 3: Decision History  
- Layer 2: Working Memory  
- Layer 1: Flow State  

### 6.2 双模式对话
- **Exploring**：澄清、对齐、更新 Creative Intent  
- **Generating**：产出候选、等待选择、推进阶段  
- **Routing**：基于意图漂移检测在两模式间切换  

---

## 7. 低延迟生成（不含预测式预生成）
- select 后立即返回 decision，后台异步生成下一阶段候选（SSE 推送）  
- 可选：结构化流式输出（streaming JSON schema）  
- 增量校验：生成过程中即时对齐与纠偏  

---

## 8. 数据模型与模块升级（规划）
### 8.1 数据模型
- Task 扩展：  
  - `creative_context`（四层上下文）  
  - `dialogue_state`（exploring / generating / selecting / conflict_resolution）  
  - `working_memory`  

### 8.2 新模块
- `InteractionRouter`（入口 + 模式路由）  
- `CreativeDialogueManager` / `IntentClarifier` / `DivergenceDetector`  
- `ScenarioRealismFilter`（场景现实性过滤）  

### 8.3 观测层
- 若启用 LangSmith：区分 `creative_dialogue` 与 `stage_generation` 追踪  

---

## 9. 实施分期
### Phase 1（入口 & 补全）
- 入口规则 + LLM 兜底 + 置信度澄清  
- 反向补全解释一致性  
- 场景现实性约束与过滤  

### Phase 2（上下文 & 双模式）
- CreativeContext + DecisionHistory + WorkingMemory  
- InteractionRouter 与意图漂移检测  

### Phase 3（低延迟）
- 异步候选生成 + SSE  
- 可选流式结构化输出  
- 增量校验  

---

## 10. 验收标准
- 入口判断准确且可解释，低置信度必澄清  
- 反向补全无隐式推进  
- 真实场景约束稳定生效  
- 选择后响应显著提速  
- 不存在预测式预生成逻辑  
