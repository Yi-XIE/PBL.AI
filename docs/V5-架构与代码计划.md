# V5 架构与代码计划（结合 005 升级建议）

本计划在 V4 基础上对齐《重构指南-架构.md》与 `docs/005.md` 的升级建议，重点引入 **四层上下文记忆**、**双模式对话/推进** 与 **低延迟生成** 机制。

---

## 1. 目标与范围

### 核心目标
1. 表单式 Intake：一次性收集知识点/课时/年龄段/教室条件。  
2. 入口由 LLM 发起“从哪里开始”询问，用户选择后进入流程。  
3. 保留双入口（scenario / tool_seed）与反向补全规则。  
4. 选择后异步生成下一阶段候选，响应更快。  
5. Course Plan 以“阶段标题 + 内容”方式展示（避免标题重复）。  
6. 新增多层上下文记忆与对话模式切换（探索/推进）。  

### 不做事项
- 不改动阶段顺序与硬依赖链。  
- 不引入外部知识库（后续版本再评估）。  

---

## 2. 四层上下文架构（005 要求）

**Layer 4 — Creative Intent（最高权重）**  
用户最初的创意意图，贯穿全流程不可覆盖。  
例：*“我要设计一个关于太空垃圾的 PBL 课程”*

**Layer 3 — Decision History**  
每个 Stage 的选择理由与用户反馈，用于一致性检查。

**Layer 2 — Working Memory**  
当前阶段的候选方案与用户反馈焦点。

**Layer 1 — Flow State**  
阶段推进、依赖检查、状态机（现有系统已具备）。

### 关键改动
在 `Task` 中新增：
```python
class CreativeContext(BaseModel):
    original_intent: str
    intent_evolution: List[IntentRevision]
    key_constraints: List[str]
    preferred_style: Optional[str]
    anchor_concepts: List[str]

class Task(BaseModel):
    creative_context: CreativeContext
    dialogue_state: DialogueState  # exploring / generating / selecting / conflict_resolution
    working_memory: WorkingMemory
```

---

## 3. 双模式对话与结构化推进（005 要求）

### 3.1 双模式路由
```python
class InteractionRouter:
    def route(user_input, task) -> InteractionMode:
        # 探索模式 / 推进模式 / 跳出当前 Stage
```

### 3.2 探索模式组件
- CreativeDialogueManager：只对话澄清，不推进 Stage  
- IntentClarifier：当输入模糊时生成澄清问题  
- DivergenceDetector：检测是否偏离 Layer4 创意意图  

### 3.3 推进模式
依旧采用现有阶段链路：  
`entry → dependency_check → require_previous → candidate_stage → user_choice_gate → stage_finalize`

**LangSmith 要求：**  
探索模式对话也必须入 trace，标记 `creative_dialogue`。

---

## 4. 低延迟生成策略（005 要求）

### 4.1 预测式预生成（Predictive Pre-generation）
当用户在探索模式对话时，后台预测可能方向并生成草案候选；  
命中后立即精化；不命中则丢弃（需置信阈值）。

### 4.2 流式结构化输出
支持 streaming JSON schema，前端边渲染候选边生成。  
用于降低感知延迟。

### 4.3 增量校验
候选逐段生成时即做一致性检查（避免最后才失败）。

---

## 5. Intake 与入口流程（现有 V4 已落地）

### 5.1 表单式 Intake
- 知识点  
- 课时（每节 40 分钟）  
- 学生年龄段（小学低/小学高/初中/高中）  
- 教室条件（常规教室/机房/通识课实验室）  

### 5.2 入口选择与触发
- tool_seed 触发条件：工具 / 实验 / 活动 / 驱动问题  
- scenario 触发条件：用户明确“从场景开始”  

### 5.3 无场景时自动生成
从知识点 + 年龄段 + 教室条件生成 starter scenario。

---

## 6. 模型与对话策略
- `LLM_MODEL`：主生成（Stage 生成）  
- `LLM_DECISION_MODEL`：决策话术（更自然、快速）  
- 探索模式可选专用小模型（未来扩展）  

---

## 7. UI 与可视化
- 左栏：Intake 表单 → Chat  
- 中栏：候选列表（仅内容 + 选择按钮）  
- 右栏：Course Plan（阶段标题 + 内容）  
- 字体统一：Candidates 与 Course Plan 同大小与字体  

---

## 8. 测试与验收

### Backend
1. intake 提交 → 入口询问  
2. tool_seed 触发 → 补齐后进入 scenario  
3. scenario 无输入 → 自动生成 starter  
4. select 后立即返回 + SSE 推送  
5. LangSmith 记录 creative_dialogue 与 intent drift  

### Frontend
1. 表单替代开场提示  
2. 提交后输入框显示  
3. Course Plan 标题 + 内容无重复  
4. 字体一致  

---

## 9. 里程碑建议
1. Phase 1：CreativeContext + InteractionRouter（不破坏现有流）  
2. Phase 2：预测预生成 + 流式结构化输出  
3. Phase 3：可视化分支 + 意图演化回放  

---

## 10. 风险与对策
1. **意图漂移误判** → 阈值 + 用户确认  
2. **预生成浪费 token** → 置信阈值 + 限额  
3. **流式输出复杂** → 优先单阶段试点  
4. **探索模式过长** → 路由器强制收敛机制  

