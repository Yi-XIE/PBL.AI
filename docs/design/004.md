# Design Doc 004 v1.0

## AI+PBL Agent æ¶æ„ï¼ˆLLM å†³ç­–  è¿‡ç¨‹å¯æ„ŸçŸ¥  åä½œå¼ç”Ÿæˆï¼‰

**çŠ¶æ€**ï¼šDraftï¼ˆå¯å®æ–½ç‰ˆï¼‰  
**æ—¥æœŸ**ï¼š2026-02-20  
**ä½œè€…**ï¼šJason Xie

---

## 1. è®¾è®¡èƒŒæ™¯

### 1.1 ä¸ºä»€ä¹ˆå»æ‰ ReAct / LangGraph æ˜¾å¼æ¨ç†

åœ¨ v3.0 è®¨è®ºä¸­ï¼Œæˆ‘ä»¬å¼•å…¥äº† ReAct ä¸ LangGraphï¼Œè¯•å›¾è§£å†³ï¼š

* AI åœ¨åšä»€ä¹ˆï¼Ÿ
* ä¸ºä»€ä¹ˆä¸‹ä¸€æ­¥æ˜¯è¿™ä¸ªï¼Ÿ
* æµç¨‹æ˜¯å¦æ™ºèƒ½æ¨è¿›ï¼Ÿ

**ä½†åœ¨å®é™…ä½“éªŒä¸å®ç°è¯„ä¼°ä¸­å‘ç°ï¼š**

1. **ReAct çš„æ¨ç†è¿‡ç¨‹å¯¹ç”¨æˆ·ä»·å€¼æä½**

   * ç”¨æˆ·ä¸å…³å¿ƒ Thought / Act / Observe
   * ä»–ä»¬åªå…³å¿ƒï¼š*ç°åœ¨åœ¨å¹²å˜›ã€ä¸ºå•¥ã€æˆ‘è¦ä¸è¦ç®¡*

2. **ReAct å¢åŠ äº†å·¥ç¨‹å¤æ‚åº¦**

   * Prompt å¤æ‚
   * çŠ¶æ€å¤š
   * Debug æˆæœ¬é«˜

3. **æ™ºèƒ½æ„Ÿä¸æ¥è‡ªæ¨ç†æ ¼å¼**

   * è€Œæ¥è‡ªï¼š

     * å†³ç­–æ˜¯å¦åˆç†
     * è§£é‡Šæ˜¯å¦åƒäºº
     * æµç¨‹æ˜¯å¦é¡º

ğŸ‘‰ å› æ­¤ï¼Œæœ¬ç‰ˆæœ¬ **å®Œå…¨ç§»é™¤ ReAct è®¾è®¡**ï¼Œ  
æ”¹ä¸º **LLM ç›´æ¥åšå†³ç­– + ç³»ç»Ÿå¼ºçº¦æŸè¾“å‡ºåè®®**ã€‚

---

## 2. Design Doc 004 çš„æ ¸å¿ƒç›®æ ‡

> ä»  
> **ã€Œçœ‹èµ·æ¥å¾ˆèªæ˜çš„ Agent æ¶æ„ã€**  
> æ”¶æ•›ä¸º  
> **ã€Œç”¨æˆ·æ˜ç¡®æ„ŸçŸ¥åˆ°åœ¨å’Œ AI åä½œå®Œæˆä¸€ä»¶äº‹ã€**

### ä¸‰æ¡ä¸å¯åŠ¨æ‘‡çš„åŸåˆ™

1. **æµç¨‹å¿…é¡»å¯æ„ŸçŸ¥**
2. **å†³ç­–å¿…é¡»å¯è§£é‡Š**
3. **ç”¨æˆ·å¿…é¡»éšæ—¶èƒ½ä»‹å…¥**

---

## 3. æ€»ä½“æ¶æ„ï¼ˆv4.0ï¼‰

```text

                Web UI                       
 Explorer | Viewer | Chat                    
 Task Progress / Step Indicator / Actions    

                 REST / SSE

              FastAPI Server                  
 Session / Task / Message / Action API        

                

              Task Manager                    
 - Task ç”Ÿå‘½å‘¨æœŸ                              
 - Stage çŠ¶æ€                                 
 - ç”¨æˆ·æ“ä½œè®°å½•                              

                

        LLM Decision & Explanation Layer      
 - å†³å®šä¸‹ä¸€æ­¥                                 
 - ç”Ÿæˆç”¨æˆ·è§£é‡Š                               
 - ç”Ÿæˆç”¨æˆ·å¼•å¯¼                               

                

          Stage Generator (LLM)               
 - å•é˜¶æ®µå†…å®¹ç”Ÿæˆ                             
 - ä¸¥æ ¼è¾“å…¥ / è¾“å‡ºåè®®                        

                

        Knowledge & Tool Layer                
 - Knowledge Templates                        
 - Web Searchï¼ˆå¯é€‰ï¼‰                         
 - Tool çŠ¶æ€å¯æ„ŸçŸ¥                            

```

---

## 4. æ ¸å¿ƒæ¦‚å¿µå®šä¹‰ï¼ˆç»Ÿä¸€è®¤çŸ¥ï¼‰

### 4.1 Taskï¼ˆä»»åŠ¡ï¼‰

> **ä¸€æ¬¡å®Œæ•´è¯¾ç¨‹è®¾è®¡ = ä¸€ä¸ª Task**

```json
Task {
  task_id: string,
  session_id: string,
  topic: string,
  stages: string[],
  current_stage: string,
  completed_stages: string[],
  status: "active" | "completed",
  created_at: timestamp
}
```

---

### 4.2 Stageï¼ˆé˜¶æ®µï¼‰

* Stage æ˜¯ **æµç¨‹å•ä½**
* æ¯ä¸ª Stageï¼š

  * åªåšä¸€ä»¶äº‹
  * å¿…é¡»æœ‰ã€Œç”¨æˆ·ç¡®è®¤ç‚¹ã€

ç¤ºä¾‹ï¼š

```text
- goal_definition
- driving_question
- question_chain
- activity_design
- assessment
- reflection
```

---

### 4.3 æœ€ç»ˆ Stage åˆ—è¡¨ä¸æ˜ å°„ï¼ˆæœ¬ç³»ç»Ÿé‡‡ç”¨ï¼‰

**æœ€ç»ˆ Stage åˆ—è¡¨ï¼ˆå½“å‰ç³»ç»Ÿï¼‰**

```text
scenario
driving_question
question_chain
activity
experiment
```

**ç¤ºä¾‹ Stage ä¸å½“å‰ç³»ç»Ÿçš„æ˜ å°„**

```text
goal_definition   -> scenario
driving_question  -> driving_question
question_chain    -> question_chain
activity_design   -> activity
assessment        -> experiment
reflection        -> experiment (å¤ç›˜åæ€å¹¶å…¥å®éªŒæ€»ç»“æ®µè½)
```

è¯´æ˜ï¼š
* ç³»ç»Ÿä»¥ `scenario -> driving_question -> question_chain -> activity -> experiment` ä¸ºå”¯ä¸€æ‰§è¡Œé¡ºåºã€‚
* å¦‚æœåç»­è¦æ‰©å±• `assessment` / `reflection`ï¼Œä¼šä½œä¸º **æ–°å¢ Stage**ï¼Œè€Œéå¤ç”¨ç°æœ‰å­—æ®µã€‚

## 5. LLM Decision & Explanation Layerï¼ˆæ ¸å¿ƒï¼‰

> **è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿåƒ Agentçš„å”¯ä¸€æ¥æº**

### 5.1 å®ƒè´Ÿè´£ä»€ä¹ˆ

 å†³å®šä¸‹ä¸€æ­¥  
 åˆ¤æ–­æ˜¯å¦å¯ä»¥æ¨è¿›  
 å‘Šè¯‰ç”¨æˆ·ä¸ºä»€ä¹ˆ  
 å‘Šè¯‰ç”¨æˆ·æ¥ä¸‹æ¥è¦å¹²å˜›

 ä¸ç”Ÿæˆå†…å®¹  
 ä¸è°ƒç”¨å·¥å…·

---

### 5.2 è¾“å…¥

```json
{
  "task": { ... },
  "current_stage": "driving_question",
  "stage_status": "pending",
  "user_action": "accept|regenerate|select_candidate|edit|reset|start|continue|tool_trigger",
  "component_validity": {
    "driving_question": true
  }
}
```

**æšä¸¾è¯´æ˜**

* `stage_status`ï¼š`pending | in_progress | completed | invalid | empty`
* `user_action`ï¼š  
  `start`ï¼ˆåˆ›å»ºä¼šè¯ï¼‰  
  `accept`ï¼ˆç¡®è®¤å½“å‰é˜¶æ®µï¼‰  
  `regenerate`ï¼ˆå¸¦åé¦ˆé‡ç”Ÿæˆï¼‰  
  `select_candidate`ï¼ˆé€‰æ‹©å€™é€‰æ–¹æ¡ˆï¼‰  
  `edit`ï¼ˆç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘åä¿å­˜ï¼‰  
  `reset`ï¼ˆé‡ç½®ä»»åŠ¡ï¼‰  
  `continue`ï¼ˆé HITL åœºæ™¯æ¨è¿›ï¼‰  
  `tool_trigger`ï¼ˆç”¨æˆ·è§¦å‘å·¥å…·ï¼‰

**è§¦å‘æ—¶æœº**
* æ¯æ¬¡ `POST /api/sessions` ä¹‹åï¼ˆstartï¼‰
* æ¯æ¬¡ `POST /api/sessions/{id}/actions` ä¹‹å
* æ¯æ¬¡ `PUT /api/sessions/{id}/files` ä¹‹å

---

### 5.3 è¾“å‡ºï¼ˆ**å¿…é¡»ç›´æ¥å±•ç¤ºç»™ç”¨æˆ·**ï¼‰

```json
{
  "next_stage": "question_chain",
  "explanation": "é©±åŠ¨é—®é¢˜å·²ç»ç¡®è®¤ï¼Œç°åœ¨éœ€è¦å¸®åŠ©å­¦ç”Ÿå½¢æˆæ¸…æ™°çš„æ€è€ƒè·¯å¾„ã€‚",
  "user_message": "ä¸‹ä¸€æ­¥æˆ‘ä¼šä¸ºä½ ç”Ÿæˆä¸€ç»„é—®é¢˜é“¾ï¼Œä½ å¯ä»¥åœ¨ç”Ÿæˆåé€æ¡è°ƒæ•´ã€‚"
}
```

> **explanation / user_message ä¸å…è®¸åªå†™ç»™ç³»ç»Ÿ**

---

## 6. Stage Generatorï¼ˆLLM å†…å®¹ç”Ÿæˆå™¨ï¼‰

### 6.1 è®¾è®¡åŸåˆ™

* ä¸€ä¸ª Stage = ä¸€æ¬¡ LLM è°ƒç”¨
* è¾“å…¥æç®€ã€ç»“æ„æ˜ç¡®
* è¾“å‡ºå¿…é¡»ç»“æ„åŒ–

---

### 6.2 è¾“å…¥ç¤ºä¾‹

```json
{
  "stage": "driving_question",
  "topic": "AI å¦‚ä½•è¯†åˆ«äº¤é€šæ ‡å¿—",
  "constraints": {
    "grade": "åˆäºŒ",
    "course_duration": 45
  },
  "knowledge_refs": ["curriculum_standard"]
}
```

---

### 6.3 è¾“å‡ºç¤ºä¾‹

```json
{
  "pending_component": "driving_question",
  "candidates": [
    {
      "id": "A",
      "title": "AI èƒ½çœ‹æ‡‚è·¯æ ‡å—ï¼Ÿ",
      "rationale": "è´´è¿‘ç”Ÿæ´»åœºæ™¯ï¼Œå®¹æ˜“å¼•å‘å…´è¶£"
    },
    {
      "id": "B",
      "title": "å¦‚æœæ²¡æœ‰äººæ•™ï¼ŒAI æ€ä¹ˆè®¤è¯†äº¤é€šæ ‡å¿—ï¼Ÿ",
      "rationale": "å¼ºè°ƒå­¦ä¹ è¿‡ç¨‹"
    }
  ]
}
```

---

### 6.4 å€™é€‰æ–¹æ¡ˆé€‰æ‹©ä¸å›å†™ï¼ˆé—­ç¯ï¼‰

**çŠ¶æ€å­—æ®µ**
```json
{
  "pending_candidates": [ ... ],
  "selected_candidate_id": "A"
}
```

**é€‰æ‹©åè®®**
* å‰ç«¯ç‚¹å‡»å€™é€‰æ–¹æ¡ˆ â†’ `POST /api/sessions/{id}/actions`  
  `{ "action": "select_candidate", "candidate_id": "A" }`
* åç«¯å°†è¯¥å€™é€‰å†™å› `course_design`ï¼ˆä¾‹å¦‚ driving_question ä¸ question_chainï¼‰ï¼Œå¹¶è¿›å…¥ç¡®è®¤æˆ–ä¸‹ä¸€é˜¶æ®µã€‚

**ç¡®è®¤è§„åˆ™**
* HITL å¼€å¯ï¼šé€‰æ‹©å€™é€‰åä»éœ€è¦ç”¨æˆ·ç¡®è®¤ï¼ˆacceptï¼‰ï¼Œæ‰è§†ä¸ºé”å®šã€‚
* HITL å…³é—­ï¼šé€‰æ‹©å€™é€‰å³è§†ä¸ºå®Œæˆï¼Œç›´æ¥æ¨è¿›ã€‚

## 7. Knowledge Templatesï¼ˆçŸ¥è¯†å³æ˜¾å¼å‚è€ƒï¼‰

### 7.1 ä¸åš RAG çš„åŸå› 

* æ•™è‚²åœºæ™¯ï¼š

  * ç¡®å®šæ€§ > è¦†ç›–ç‡
* è¯¾ç¨‹æ ‡å‡†ä¸èƒ½æ¼‚

---

### 7.2 ä½¿ç”¨æ–¹å¼

```text
knowledge/
 curriculum_standard.md
 pbl_principles.md
 age_guidelines.json
 common_pbl_mistakes.md
```

### 7.3 ç”¨æˆ·å¯æ„ŸçŸ¥æç¤ºï¼ˆå¯é€‰ï¼‰

> â„¹ æœ¬æ­¥éª¤å‚è€ƒäº†ã€Šè¯¾ç¨‹æ ‡å‡†ã€‹ä¸­å…³äºçœŸå®æ€§ä»»åŠ¡çš„è¦æ±‚ã€‚

**è§¦å‘è§„åˆ™ï¼ˆå½“å‰å®ç°ï¼‰**
* è‹¥ `knowledge_snippets` éç©ºï¼Œåˆ™åœ¨ç”Ÿæˆé˜¶æ®µåè¿½åŠ ä¸€æ¬¡è¯´æ˜ã€‚
* åŒä¸€æ¡æç¤ºä¸é‡å¤è¿½åŠ ï¼ˆæŒ‰ message å»é‡ï¼‰ã€‚

---

## 8. Tool Layerï¼ˆå®Œå…¨ç”¨æˆ·å¯æ§ï¼‰

### 8.1 å·¥å…·ä¸è‡ªåŠ¨è§¦å‘

* æ‰€æœ‰å·¥å…·ï¼š

  * å¿…é¡»ç”±ç”¨æˆ·è§¦å‘
  * å¿…é¡»å±•ç¤ºçŠ¶æ€

---

### 8.2 Tool çŠ¶æ€æ¶ˆæ¯åè®®

```json
{
  "type": "tool_status",
  "tool": "web_search",
  "status": "running",
  "message": "æ­£åœ¨æŸ¥æ‰¾çœŸå®æ•™å­¦æ¡ˆä¾‹..."
}
```

### 8.3 å·¥å…·è§¦å‘åè®®

```json
POST /api/sessions/{id}/tools
{
  "tool": "web_search",
  "query": "AI äº¤é€šæ ‡å¿— è¯¾å ‚æ¡ˆä¾‹"
}
```

è¿”å›å†…å®¹ä»é€šè¿‡ `messages` è¾“å‡ºå·¥å…·çŠ¶æ€ã€‚

---

## 9. ç”¨æˆ·å¯æ„ŸçŸ¥æ¶ˆæ¯æ¨¡å‹ï¼ˆç»Ÿä¸€ï¼‰

ç³»ç»Ÿå¯¹è¯å¯¹ç”¨æˆ· **åªæœ‰ä¸‰ç±»**ï¼Œä½†åè®®å…è®¸ **ç¬¬å››ç±»å·¥å…·çŠ¶æ€**ï¼š

**æ¶ˆæ¯ç±»å‹ï¼ˆåè®®ï¼‰**
* `status`
* `explanation`
* `action`
* `tool_status`ï¼ˆå·¥å…·çŠ¶æ€ï¼Œå½’ç±»ä¸ºâ€œçŠ¶æ€è¯´æ˜â€ï¼‰

### 1 çŠ¶æ€è¯´æ˜

> ğŸ¤– æ­£åœ¨ç”Ÿæˆé©±åŠ¨é—®é¢˜ï¼ˆç¬¬ 2 / 6 æ­¥ï¼‰

### 2 å†³ç­–è§£é‡Š

> â„¹ å› ä¸ºè¯¾ç¨‹ç›®æ ‡å·²ç»æ˜ç¡®ï¼Œç°åœ¨éœ€è¦è®¾è®¡å­¦ç”Ÿçš„æ€è€ƒè·¯å¾„ã€‚

### 3 è¡ŒåŠ¨å¼•å¯¼

> æˆ‘ç”Ÿæˆäº† 2 ä¸ªæ–¹æ¡ˆï¼Œä½ å¯ä»¥é€‰æ‹©ä¸€ä¸ªæˆ–ç›´æ¥ä¿®æ”¹ã€‚

---

## 10. æ•°æ®æµï¼ˆå®Œæ•´ä¸€æ¬¡ï¼‰

1. åˆ›å»º Session
2. åˆ›å»º Task
3. Decision Layer å†³å®šèµ·å§‹ Stage
4. Stage Generator ç”Ÿæˆå†…å®¹
5. ç”¨æˆ·ç¡®è®¤ / ç¼–è¾‘
6. Decision Layer è§£é‡Šå¹¶æ¨è¿›
7. æ‰€æœ‰ Stage å®Œæˆ  Task å®Œæˆ
8. æç¤ºå¯¼å‡ºè¯¾ç¨‹æ–¹æ¡ˆ

---

## 11. API åè®®ï¼ˆæœ€å°å¯ç”¨ï¼‰

**åˆ›å»ºä¼šè¯**
```json
POST /api/sessions
{
  "topic": "...",
  "grade_level": "...",
  "duration": 45,
  "classroom_mode": "normal",
  "classroom_context": "",
  "hitl_enabled": true,
  "cascade_default": true,
  "multi_option": true,
  "user_input": "..."
}
```

**æŸ¥è¯¢ä¼šè¯**
```json
GET /api/sessions/{id}
{
  "task": { ... },
  "messages": [ ... ],
  "state": { ... },
  "virtual_files": { ... }
}
```

**åŠ¨ä½œ**
```json
POST /api/sessions/{id}/actions
{ "action": "accept|regenerate|select_candidate|reset", "feedback": "...", "candidate_id": "A" }
```

**å·¥å…·**
```json
POST /api/sessions/{id}/tools
{ "tool": "web_search", "query": "..." }
```

---

## 12. Task ç”Ÿå‘½å‘¨æœŸä¸å­˜å‚¨

* Session åˆ›å»ºæ—¶åŒæ­¥åˆ›å»º Taskã€‚
* Task ä¸ messages å­˜å…¥ Session Storeï¼Œéš `GET /api/sessions/{id}` è¿”å›ã€‚
* æ¯æ¬¡çŠ¶æ€å˜åŒ–ååˆ·æ–° Taskï¼ˆcurrent_stage / completed_stages / statusï¼‰ã€‚
* ä»»åŠ¡å®Œæˆæ¡ä»¶ï¼šæ‰€æœ‰ required stages å·²å®Œæˆã€‚

---

## 13. REST vs SSE

* **å½“å‰é»˜è®¤ï¼šREST**ï¼ˆå‰ç«¯è¯·æ±‚åå±•ç¤º messagesï¼‰ã€‚
* **SSE å¯é€‰æ‰©å±•**ï¼šç”¨äºé•¿æ—¶é—´ç”Ÿæˆçš„ä¸­é—´çŠ¶æ€æ¨é€ã€‚
* SSE ä¸ REST å…¼å®¹ï¼šSSE å¤±è´¥æ—¶å›é€€åˆ° REST è½®è¯¢ã€‚

---

## 14. é”™è¯¯ä¸å¯ç”¨æ€§

* ç¼ºå°‘ API Keyï¼šè¿”å› `error` å­—æ®µï¼Œå‰ç«¯æ˜¾ç¤ºé”™è¯¯å¹¶åœæ­¢è‡ªåŠ¨æ¨è¿›ã€‚
* LLM å¤±è´¥ï¼šè¿”å›å¯è¯»é”™è¯¯æ¶ˆæ¯ï¼ˆä¸è¿”å›å †æ ˆï¼‰ã€‚
* ç”¨æˆ·åé¦ˆä¸ºç©ºæ—¶ç¦æ­¢ regenerateã€‚
* å½“ Await User æ—¶ï¼Œå¿…é¡»æä¾›æ˜ç¡®æ“ä½œæŒ‰é’®ï¼ˆç¡®è®¤ / ä¿®æ”¹ / é€‰æ‹©å€™é€‰ï¼‰ã€‚

---

## 15. å…³é”®æ¶æ„å…±è¯†ï¼ˆå†™ç»™æœªæ¥çš„è‡ªå·±ï¼‰

* ä¸è¿½æ±‚æ¨ç†çœ‹èµ·æ¥å¾ˆé«˜çº§

* è¿½æ±‚ç”¨æˆ·æ„Ÿè§‰åœ¨ä¸€èµ·åšäº‹

* ä¸è®©ç”¨æˆ·ç†è§£ Agent æ¶æ„

* è®©ç”¨æˆ·ç†è§£ **AI çš„æ„å›¾**
