# 重构指南（计划，从0搭建 + LangSmith）

面向新的 Codex，从零搭建的可执行开发计划，包含 LangSmith 监控接入。

**里程碑 0：观测基线**
1. 接入 LangSmith SDK 与环境变量。
2. 建立 root run 与子 run 结构规范。
3. 定义 trace 元数据规范：`task_id` `stage` `entry_point` `action`。
4. 验收：能在 LangSmith 控制台检索到任务链路。

**里程碑 1：核心域模型与依赖引擎**
1. 交付：`Task`、`StageArtifact`、`Candidate`、`ToolSeed`。
2. 交付：依赖表 + 反向补全逻辑 + 下一阶段决策输出。
3. 验收：给定 `tool_seed` 能计算出 `scenario` 为下一步。
4. 硬约束：反向补全逻辑只负责计算缺失依赖与推荐路径，不得触发 Stage Generator 或隐式生成内容。

**里程碑 2：候选生成与分支记录**
1. 交付：每 Stage ≥3 候选生成器接口。
2. 交付：分支图记录与选择锁定。
3. 验收：选择候选后，未选分支被冻结且可回放。
4. 硬约束：冻结分支不可被重新激活，只允许通过新 Task 重新探索。

**里程碑 3：冲突校验与解释输出**
1. 交付：Activity 对齐校验与冲突 A/B/C 选项。
2. 交付：Decision Layer 输出 `explanation` 与 `user_message`。
3. 验收：触发冲突后能生成解释与可选动作。
4. 硬约束：冲突分级必须写死为 `blocking / warning / info`，并绑定对应推进策略。

**里程碑 4：API 与 SSE**
1. 交付：`/api/tasks`、`/api/tasks/{id}`、`/api/tasks/{id}/action`、`/api/tasks/{id}/progress`、`/api/tasks/{id}/events`。
2. 验收：单纯通过 API 完成完整课程流程。

**里程碑 5：UI 与验收**
1. 交付：UI 展示当前阶段、解释、候选选择与冲突处理。
2. 验收：从 `tool_seed` 与 `scenario` 两个入口都能顺利完成任务。

**必须保证的最终验收点**
1. Tool Seed 入口与 Scenario 入口体验一致。
2. 每次系统行为都有解释信息。
3. 分支记录与候选锁定正确。
4. 新增 Stage 只需改依赖表与生成器映射。
5. LangSmith 能回放完整 Task 链路。
6. 四条核心原则与角色边界得到落实（流程可感知 / 决策可解释 / 用户介入 / 依赖硬编码）。
7. Activity 双重对齐与冲突 A/B/C 流程可验证。

**易翻车点（必须防御）**
1. Stage 完成判定必须同时满足：存在 `selected_candidate_id`；对应 `candidate.status == "selected"`；Validator 未返回 blocking conflict。
2. 反向补全是“建议”而非“隐式执行”：依赖缺失时必须先返回 `explanation + next_step` 给用户，不允许直接自动生成缺失 Stage 作为隐式决策。
3. LangSmith Run 粒度：禁止在一个 Run 中完成多个 Stage 的生成，每个 Stage 必须独立 Run，避免回放边界模糊。

**优化建议（策略层）**
1. Decision Layer 与 Generator 完全隔离，禁止互相调用。
2. 所有状态变更走统一 reducer，避免隐式修改。
3. 生成输出先写入 StageArtifact，再更新 Task 进度。
4. 引擎层提供“dry-run”模式，便于验证依赖与路径。
5. 测试覆盖 Tool Seed 反向补全与冲突处理全链路。
