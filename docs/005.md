Design Doc 005 架构（最新版）

## 关键洞察：你的架构需要三个层面的升级

### 1. 上下文架构：从"管道"到"全息记忆"

当前架构中，上下文是阶段间传递的"包裹"，但创意对话需要**多维度、可检索、有权重**的记忆系统。

```
建议的上下文分层：

┌─────────────────────────────────────┐
│  Layer 4: 创意意图层 (Creative Intent)  │ ← 用户最初的大想法，全程高权重保留
│  "我要设计一个关于太空垃圾的PBL课程"      │
├─────────────────────────────────────┤
│  Layer 3: 决策历史层 (Decision History) │ ← 每个Stage的选择理由，用于一致性检查
│  为什么选择方案B而不是A                │
├─────────────────────────────────────┤
│  Layer 2: 当前焦点层 (Working Memory)   │ ← 当前正在打磨的内容，对话主要操作区
│  当前Stage的候选方案与用户反馈          │
├─────────────────────────────────────┤
│  Layer 1: 流程状态层 (Flow State)       │ ← 你的现有架构，阶段推进、依赖检查
│  当前在哪个Stage，完成了什么            │
└─────────────────────────────────────┘
```

**关键改动**：在 `Task` 模型中增加 `creative_intent` 字段，这是**不可被覆盖的锚点**。每次生成候选时，Generator 必须接收完整的四层上下文，但 LLM 的注意力权重不同。

### 2. 对话流与结构化流的融合架构

你需要一个**双模式引擎**：

```
用户输入 → 意图识别器 → 分支判断
                ↓
        ┌───────┴───────┐
        ↓               ↓
   【探索模式】      【推进模式】
   (对话/澄清/发散)   (生成候选/选择/确认)
        ↓               ↓
   更新Layer 3&4    更新Layer 1&2
        └───────┬───────┘
                ↓
        统一的状态更新 → 事件流
```

**探索模式**的新组件：
- `CreativeDialogueManager`: 处理多轮对话，不推进Stage，但更新 `creative_intent` 和 `decision_history`
- `IntentClarifier`: 当用户输入模糊时，生成澄清问题（也是LLM调用，但属于对话而非生成）
- `DivergenceDetector`: 检测用户是否想"跳出"当前Stage去讨论其他内容

**关键规则**：探索模式的对话也必须进入 LangSmith trace，标记为 `creative_dialogue` 类型，与 `stage_generation` 区分。

### 3. 低延迟架构：预生成与流式传输

多候选生成是延迟大户，建议采用**投机生成策略**：

```
候选生成策略：

1. 预测性预生成 (Predictive Pre-generation)
   - 当用户在探索模式对话时，后台预测用户可能想要的3个方向
   - 提前生成"草稿候选"，用户确认方向后立即精化
   - 风险：预测错误时浪费token，需设置置信度阈值

2. 流式结构化生成 (Streaming Structured Output)
   - 不等待3个候选全部完成再返回
   - 先返回候选1的流，用户开始看时，后台生成候选2、3
   - 技术：使用支持流式JSON schema的LLM（如OpenAI的structured outputs streaming）

3. 增量验证 (Incremental Validation)
   - 不等到最后才检查对齐
   - 每个候选生成过程中实时检查与Layer 4的偏离
   - 偏离时立即调整，而非生成完再废弃
```

## 具体架构调整建议

### 核心层扩展 (`core/`)

```python
# 新增：创意上下文模型
class CreativeContext(BaseModel):
    original_intent: str           # Layer 4: 用户最初输入，永不修改
    intent_evolution: List[IntentRevision]  # 意图如何被澄清和细化
    key_constraints: List[str]     # 用户强调过的硬性约束
    preferred_style: Optional[str] # 用户偏好的表达方式（从对话中提取）
    anchor_concepts: List[str]     # 必须保留的核心概念（自动提取）

class IntentRevision(BaseModel):
    timestamp: datetime
    trigger: str                   # 什么对话触发了修订
    before: str
    after: str
    user_confirmed: bool           # 是否经过用户确认

# 修改：Task模型扩展
class Task(BaseModel):
    # ... 原有字段 ...
    creative_context: CreativeContext
    dialogue_state: DialogueState  # 当前是在探索还是推进
    working_memory: WorkingMemory  # Layer 2的显式表示
    
class DialogueState(Enum):
    EXPLORING = "exploring"        # 自由对话，澄清意图
    GENERATING = "generating"      # 正在生成候选
    SELECTING = "selecting"        # 等待用户选择
    CONFLICT_RESOLUTION = "conflict_resolution"
```

### 引擎层重构 (`engine/`)

```python
# 新增：双模式路由器
class InteractionRouter:
    def route(self, user_input: str, current_state: Task) -> InteractionMode:
        """
        判断用户是想：
        A. 继续当前Stage的创意对话（探索模式）
        B. 确认并生成/选择候选（推进模式）  
        C. 跨Stage讨论（需要特殊处理）
        """
        
    def detect_intent_shift(self, history: List[Message], new_input: str) -> float:
        """
        检测用户是否改变了核心意图（与Layer 4的偏离度）
        返回0-1的分数，超过阈值触发意图澄清流程
        """

# 修改：依赖检查器，支持"软依赖"
class DependencyChecker:
    def check(self, target_stage: StageType, context: CreativeContext) -> DependencyResult:
        """
        原有硬依赖检查 + 新增：检查创意连贯性
        如果用户最初想的是"生物"，现在要到"activity"了却提到"机器人"，
        这不是依赖缺失，而是可能的意图漂移，需要提醒而非自动补全
        """
```

### 生成器层优化 (`generators/`)

```python
# 修改：候选生成器，支持上下文加权
class ContextualCandidateGenerator:
    def generate(self, stage: StageType, context: CreativeContext, 
                 dialogue_history: List[Message]) -> List[Candidate]:
        """
        Prompt构造策略：
        1. System Prompt中强调original_intent的高权重
        2. 使用 few-shot 展示如何从对话历史中提取约束
        3. 生成时实时检查与anchor_concepts的对齐
        """
        
    def _build_weighted_context(self, context: CreativeContext) -> str:
        """
        不是简单拼接，而是根据阶段调整权重描述：
        - Stage早期（scenario/driving_question）：强调original_intent
        - Stage晚期（activity/experiment）：强调decision_history中的选择理由
        """

# 新增：对话响应生成器（用于探索模式）
class DialogueResponder:
    def respond(self, user_input: str, context: CreativeContext) -> DialogueResponse:
        """
        不生成正式候选，而是：
        - 总结用户意图
        - 提出澄清问题  
        - 建议可能的探索方向
        - 检测是否已足够清晰，可以切换到推进模式
        """
```

### 适配器层增强 (`adapters/`)

```python
# 新增：流式输出适配器
class StreamingGenerator:
    async def generate_streaming_candidates(self, prompt: str, schema: dict) -> AsyncIterator[CandidateChunk]:
        """
        返回候选的流式片段，前端可以实时渲染
        每个候选标记为 candidate_1, candidate_2, candidate_3
        完成后组装成完整Candidate对象
        """

# 修改：LangSmith追踪器，支持创意对话
class CreativeLangSmithTracer:
    def trace_dialogue_turn(self, task_id: str, user_input: str, 
                           response: str, context_snapshot: CreativeContext):
        """
        探索模式的对话也要追踪，标记为 creative_dialogue
        包含 context_snapshot 的哈希，用于后续一致性审计
        """
        
    def trace_intent_drift(self, task_id: str, detected_drift: float, 
                          action_taken: str):
        """
        专门追踪意图漂移事件，这对创意系统很关键
        """
```

## 关键流程示例

### 场景：用户从 tool_seed 开始，但想法还不清晰

```
用户：我想用AI工具设计课程，但还没想好主题

系统（探索模式）：
├─ 检测：输入模糊，无明确scenario
├─ 路由：进入探索模式  
├─ 生成：DialogueResponder 提出3个探索方向
│   1. "你更关注哪个学科领域？"
│   2. "你希望学生解决什么类型的问题？"  
│   3. "有特定的技术工具偏好吗？"
└─ LangSmith: trace_dialogue_turn (type: clarification)

用户：我对环保感兴趣，特别是海洋塑料污染，想让学生用数据分析工具

系统（仍探索模式）：
├─ 更新：CreativeContext.original_intent = "海洋塑料污染+数据分析"
├─ 检测：意图已清晰，但需确认约束
├─ 生成："确认一下：主题是海洋塑料污染，工具是数据分析类，对吗？"
└─ 预生成：后台开始准备scenario的草稿候选

用户：对的，但我希望是小学高年级能理解的

系统（切换到推进模式）：
├─ 更新：CreativeContext.key_constraints.append("小学高年级认知水平")
├─ 路由：进入推进模式，触发scenario生成
├─ 生成：返回3个scenario候选（利用预生成结果快速响应）
└─ LangSmith: trace_stage_generation (parent_run=task_id)
```

## 性能优化清单

| 瓶颈 | 解决方案 | 预期延迟 |
|------|---------|---------|
| 3候选串行生成 | 并行生成 + 流式返回首候选 | 首候选<2s，全部<5s |
| 长上下文处理 | 分层摘要，Layer 4永全量，历史用摘要 | 减少50% token |
| 依赖检查复杂 | 硬依赖预计算缓存，软依赖异步检查 | <100ms |
| LangSmith写入 | 异步批量写入，关键路径不阻塞 | 无感知 |

## 升级路径建议

**Phase 1（立即）**：实现 `CreativeContext` 和 `InteractionRouter`，保持现有流程，但增加"对话模式"作为Stage前的可选步骤。

**Phase 2（短期）**：实现流式生成和预生成，优化延迟；增加意图漂移检测。

**Phase 3（中期）**：完整的分支可视化（让用户看到创意如何演化）；支持跨Stage的"灵感回溯"（不破坏冻结规则，但允许查看历史灵感）。

这个架构的核心哲学是：**硬流程保证不翻车，软对话保证不僵化**。LangSmith 的追踪也要相应区分 "流程事件" 和 "创意事件"，让你能分别审计系统的稳定性和创意的连贯性。

需要我深入设计某个具体组件（如 `InteractionRouter` 的意图分类逻辑，或流式生成的具体实现）吗？