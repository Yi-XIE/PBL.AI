# 重构指南（实施，从0搭建 + LangSmith）

本文件面向新的 Codex，从零搭建时的实现指导与运行方式，并包含 LangSmith 监控接入。

**必要功能清单**
1. 多起点：`scenario` / `tool_seed`。
2. 依赖管理：缺依赖时反向补全。
3. 多候选：每 Stage ≥3 候选。
4. 分支记录：选择后锁定分支。
5. 冲突处理：Activity 对齐校验 + 解决方案 A/B/C。
6. 解释输出：`explanation` 与 `user_message`。
7. API：创建任务、提交动作、查询进度、SSE 事件。
8. LangSmith：全链路 trace。

**推荐接口设计（必须实现）**
- `POST /api/tasks`
  - 创建任务，输入支持 `tool_seed` 或 `scenario`。
- `GET /api/tasks/{task_id}`
  - 获取 Task 状态与当前候选。
- `POST /api/tasks/{task_id}/action`
  - 支持 `accept` / `select_candidate` / `regenerate` / `resolve_conflict`。
- `GET /api/tasks/{task_id}/progress`
  - 获取当前 Stage 与进度。
- `GET /api/tasks/{task_id}/events`
  - SSE，推送候选与消息。

**Action 请求示例**
```json
{
  "action": "select_candidate",
  "candidate_id": "B",
  "target_component": "scenario"
}
```

**冲突解决示例**
```json
{
  "action": "resolve_conflict",
  "payload": { "option": "B" }
}
```

**LangSmith 接入（必须实现）**
1. 依赖安装：`pip install langsmith`。
2. 环境变量：
   - `LANGCHAIN_TRACING_V2=true`
   - `LANGCHAIN_API_KEY=...`
   - `LANGCHAIN_PROJECT=ai-pbl-agent`
   - 可选 `LANGCHAIN_ENDPOINT=https://api.smith.langchain.com`
3. 代码层面：
   - 在 LLM 调用处开启 tracing。
   - 每个 Task 建立 root run，子 run 覆盖 Decision、Generator、Validator、API Action。
   - `task_id`、`stage` 写入 metadata，便于检索。
4. 脱敏策略：
   - `user_input`、`tool_seed` 可记录摘要或 hash。
   - 候选内容可截断保留前 N 字。
5. 报错处理：
   - 任何异常必须写入 LangSmith run error 字段。

**易翻车点（必须显式处理）**
1. Stage 完成判定必须同时满足：存在 `selected_candidate_id`；对应 `candidate.status == "selected"`；Validator 未返回 blocking conflict。
2. 反向补全是“建议”而非“隐式执行”：依赖缺失时必须先返回 `explanation + next_step` 给用户，不允许直接自动生成缺失 Stage 作为隐式决策。
3. LangSmith Run 粒度：禁止在一个 Run 中完成多个 Stage 的生成，每个 Stage 必须独立 Run，避免回放边界模糊。

**从0搭建的实现顺序建议**
1. 实现 `core/`：Task、StageArtifact、Candidate、ToolSeed、Stage 依赖表。
2. 实现 `engine/`：依赖检查、反向补全、下一阶段决策。
3. 实现 `generators/`：每 Stage 生成 3 个候选，输出统一结构。
4. 实现 `validators/`：Activity 校验与冲突选项输出。
5. 实现 `services/`：Task Manager、Decision Layer、Message Builder。
6. 实现 `adapters/`：LLM + LangSmith tracing 封装。
7. 实现 `api/`：FastAPI 路由与 SSE。
8. 实现 `ui/`：候选选择、解释显示、冲突处理。

**关键运行命令（新项目建议）**
安装依赖：
```bash
pip install -r requirements.txt
```

运行 API：
```bash
uvicorn api.app:app --host 127.0.0.1 --port 8000
```

快速验证（curl 示例）：
```bash
curl -X POST http://127.0.0.1:8000/api/tasks \
  -H "Content-Type: application/json" \
  -d '{"entry_point":"tool_seed","tool_seed":{"tool_name":"Orange","algorithms":["KNN"],"constraints":{"grade":"初二"}}}'
```

**优化建议（实现层）**
1. 状态更新做成幂等：同一 action 重放不改变最终状态。
2. 依赖计算缓存：减少重复计算与 LLM 调用。
3. 生成器接口统一 schema：降低 UI 与 API 的耦合成本。
4. 所有生成输出落盘：便于回放、审计与模型评估。
5. SSE 事件推送包含 `task_id`、`stage`、`run_id`。

**必须保留的能力清单（落地时不可省略）**
1. 四条核心原则：流程可感知、决策可解释、用户随时介入、依赖由系统硬编码管理。
2. 角色边界：流程引擎只做依赖/分支/约束，不生成不解释不对话；LLM 只做生成/解释，不管理状态。
3. Tool Seed 入口 + 反向补全 + Activity 双重对齐。
4. 多候选强制 + 候选元数据（`rationale` / `derived_from` / `alignment_score` / `generation_context`）。
5. 分支冻结与不可回退规则。
6. 冲突处理 A/B/C 流程与分级策略。
7. Hidden Flow Graph 的语义节点链路。
8. 关键降级策略：LLM 不可用、依赖循环、用户超时未选。

**验收标准（必须通过）**
1. `tool_seed` 起点可完成 5 个 Stage，且流程解释正确。
2. 反向补全触发时，系统能说明原因并返回候选。
3. 每个 Stage 至少 3 个候选，并能正确选择与锁定分支。
4. Activity 与 Tool Seed 冲突时给出 A/B/C 选项。
5. API 与 SSE 能驱动完整交互链路。
6. LangSmith 能回放完整 Task 链路。
