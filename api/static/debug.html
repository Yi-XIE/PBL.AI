<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>PBL Studio V4 Copilot Debug</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Azeret+Mono:wght@400;600&family=Bricolage+Grotesque:wght@300;400;600;700&family=Fraunces:wght@600;700&display=swap");

      :root {
        --bg: #f4f6fb;
        --panel: rgba(255, 255, 255, 0.92);
        --panel-2: rgba(248, 250, 255, 0.98);
        --border: rgba(15, 23, 42, 0.12);
        --text: #111827;
        --muted: #6b7280;
        --accent: #2dd4bf;
        --accent-2: #7c3aed;
        --warn: #ef4444;
        --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
        --bg-spot-1: rgba(45, 212, 191, 0.12);
        --bg-spot-2: rgba(124, 58, 237, 0.1);
        --bg-spot-3: rgba(56, 189, 248, 0.12);
        --grid-line: rgba(15, 23, 42, 0.04);
        --font-body: "Bricolage Grotesque", system-ui, sans-serif;
        --font-display: "Fraunces", serif;
        --font-mono: "Azeret Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }

      body[data-theme="dark"] {
        --bg: #0b0f16;
        --panel: rgba(16, 22, 34, 0.92);
        --panel-2: rgba(11, 16, 26, 0.92);
        --border: rgba(255, 255, 255, 0.08);
        --text: #eef3ff;
        --muted: #98a2b3;
        --accent: #67f2d0;
        --accent-2: #f186ff;
        --warn: #ff8b7a;
        --shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
        --bg-spot-1: rgba(103, 242, 208, 0.08);
        --bg-spot-2: rgba(241, 134, 255, 0.08);
        --bg-spot-3: rgba(86, 119, 255, 0.08);
        --grid-line: rgba(255, 255, 255, 0.02);
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: var(--font-body);
        background: radial-gradient(1200px 800px at 10% 10%, var(--bg-spot-1), transparent 60%),
          radial-gradient(900px 600px at 90% 0%, var(--bg-spot-2), transparent 55%),
          radial-gradient(900px 700px at 50% 100%, var(--bg-spot-3), transparent 60%),
          var(--bg);
        color: var(--text);
        min-height: 100vh;
        height: 100vh;
        overflow: hidden;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image: linear-gradient(var(--grid-line) 1px, transparent 1px),
          linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
        background-size: 32px 32px;
        pointer-events: none;
        opacity: 0.15;
      }

      .app {
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 0;
        height: 100%;
        overflow: hidden;
        padding: 20px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding: 14px 18px;
        border-radius: 18px;
        border: 1px solid var(--border);
        background: var(--panel);
        box-shadow: var(--shadow);
        backdrop-filter: blur(18px);
      }

      .brand {
        font-family: var(--font-display);
        font-size: 22px;
        letter-spacing: 0.5px;
      }

      .status {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .theme-toggle {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.05);
        color: var(--text);
        font-size: 12px;
        padding: 8px 12px;
        border-radius: 999px;
        cursor: pointer;
      }

      .theme-toggle svg {
        width: 16px;
        height: 16px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1.1fr 1fr 1.2fr;
        gap: 16px;
        flex: 1;
        min-height: 0;
      }

      .panel {
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 0;
        padding: 16px;
        border-radius: 18px;
        border: 1px solid var(--border);
        background: var(--panel);
        box-shadow: var(--shadow);
        backdrop-filter: blur(18px);
      }

      .panel-header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }

      .panel-header h2 {
        margin: 0;
        font-family: var(--font-display);
        font-size: 16px;
      }

      .subtle {
        font-size: 12px;
        color: var(--muted);
      }

      .chat-log {
        flex: 1;
        min-height: 0;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-right: 4px;
        scrollbar-color: transparent transparent;
      }

      .chat-log::-webkit-scrollbar {
        width: 8px;
      }

      .chat-log::-webkit-scrollbar-track {
        background: transparent;
      }

      .chat-log::-webkit-scrollbar-thumb {
        background-color: transparent;
      }

      .message {
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-width: 90%;
        align-self: flex-start;
        align-items: flex-start;
      }

      .message.user {
        align-self: flex-start;
      }

      .message.assistant {
        align-self: flex-start;
      }

      .message.system {
        align-self: flex-start;
        max-width: 100%;
      }

      .message .meta {
        font-size: 11px;
        color: var(--muted);
        letter-spacing: 0.6px;
        text-transform: uppercase;
      }

      .message .bubble {
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(15, 23, 42, 0.08);
        background: rgba(255, 255, 255, 0.85);
        line-height: 1.5;
        white-space: pre-wrap;
        font-size: 12px;
      }

      .message .bubble.thinking {
        background: rgba(124, 58, 237, 0.1);
        border-color: rgba(124, 58, 237, 0.22);
      }

      .thinking-dots {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        min-height: 16px;
      }

      .thinking-dots span {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: var(--muted);
        opacity: 0.35;
        animation: thinkingPulse 1.1s infinite ease-in-out;
      }

      .thinking-dots span:nth-child(2) {
        animation-delay: 0.15s;
      }

      .thinking-dots span:nth-child(3) {
        animation-delay: 0.3s;
      }

      @keyframes thinkingPulse {
        0%,
        80%,
        100% {
          transform: translateY(0);
          opacity: 0.3;
        }
        40% {
          transform: translateY(-4px);
          opacity: 0.9;
        }
      }

      .message.user .bubble {
        background: rgba(45, 212, 191, 0.14);
        border-color: rgba(45, 212, 191, 0.4);
      }

      .message.assistant .bubble {
        background: rgba(124, 58, 237, 0.12);
        border-color: rgba(124, 58, 237, 0.28);
      }

      .message.system .bubble {
        background: rgba(15, 23, 42, 0.04);
        border-color: rgba(15, 23, 42, 0.12);
        font-size: 12px;
      }

      .composer {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .hidden {
        display: none;
      }

      .intake-form {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.8);
      }

      .form-row {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .form-row label {
        font-size: 12px;
        color: var(--muted);
      }

      .form-row input,
      .form-row select,
      .form-row textarea {
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #ffffff;
        color: var(--text);
        padding: 8px 10px;
        font-size: 13px;
        font-family: var(--font-body);
      }

      .form-hint {
        font-size: 11px;
        color: var(--muted);
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
      }

      .input-wrap {
        position: relative;
      }

      #chatInput {
        width: 100%;
        min-height: 90px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: #ffffff;
        color: var(--text);
        padding: 12px 78px 42px 12px;
        font-family: var(--font-body);
        font-size: 13px;
        resize: vertical;
      }

      .send-btn {
        position: absolute;
        right: 10px;
        bottom: 10px;
        width: 40px;
        height: 40px;
        padding: 0;
        border-radius: 12px;
        display: grid;
        place-items: center;
        border: none;
        background: transparent;
        color: var(--text);
      }

      .send-btn svg {
        width: 18px;
        height: 18px;
      }

      button {
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.05);
        color: var(--text);
        font-size: 12px;
        padding: 8px 12px;
        border-radius: 12px;
        cursor: pointer;
        transition: transform 0.15s ease, border-color 0.2s ease, background 0.2s ease;
      }

      button:hover {
        transform: translateY(-1px);
        border-color: rgba(15, 23, 42, 0.2);
        background: rgba(15, 23, 42, 0.08);
      }

      button.primary {
        background: transparent;
        border-color: transparent;
      }

      .send-btn:hover {
        transform: none;
        background: transparent;
        border-color: transparent;
        opacity: 1;
      }


      button.ghost {
        background: transparent;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .hint {
        font-size: 11px;
        color: var(--muted);
      }

      .stage-track {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .stage-pill {
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid var(--border);
        color: var(--muted);
      }

      .stage-pill.active {
        color: var(--text);
        border-color: rgba(45, 212, 191, 0.5);
        background: rgba(45, 212, 191, 0.12);
      }

      .stage-pill.done {
        color: var(--text);
        border-color: rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.08);
      }

      .candidate-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow: auto;
        min-height: 0;
        padding-right: 4px;
      }

      .candidate-card {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.7);
        transition: border-color 0.2s ease, background 0.2s ease;
      }

      .candidate-card:hover {
        border-color: rgba(15, 23, 42, 0.2);
        background: rgba(255, 255, 255, 0.9);
      }

      .candidate-card.selected {
        border-color: rgba(45, 212, 191, 0.6);
        background: rgba(45, 212, 191, 0.12);
      }

      .candidate-content {
        font-size: 13px;
        font-family: var(--font-body);
        line-height: 1.55;
      }

      .markdown {
        font-family: var(--font-body);
        font-size: 13px;
      }

      .candidate-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 4px;
      }

      .markdown h1,
      .markdown h2,
      .markdown h3,
      .markdown h4 {
        margin: 0 0 8px;
        font-family: var(--font-body);
        font-size: 13px;
        font-weight: 600;
      }

      .markdown p {
        margin: 0 0 8px;
      }

      .markdown ul,
      .markdown ol {
        margin: 6px 0 10px 18px;
        padding: 0;
      }

      .markdown li {
        margin-bottom: 4px;
      }

      .markdown blockquote {
        margin: 8px 0;
        padding-left: 10px;
        border-left: 2px solid var(--border);
        color: var(--muted);
      }

      .markdown code {
        font-family: var(--font-mono);
        font-size: 12px;
        background: rgba(15, 23, 42, 0.06);
        padding: 2px 6px;
        border-radius: 6px;
      }

      .markdown pre {
        font-family: var(--font-mono);
        font-size: 12px;
        background: rgba(15, 23, 42, 0.06);
        padding: 10px;
        border-radius: 10px;
        overflow-x: auto;
      }

      .detail-box {
        flex: 1;
        overflow: auto;
        min-height: 0;
        padding-right: 4px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      details {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.8);
      }

      details summary {
        cursor: pointer;
        font-weight: 600;
      }

      .section-body {
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.5;
        white-space: pre-wrap;
      }

      .code {
        font-family: var(--font-mono);
        font-size: 11px;
        background: rgba(15, 23, 42, 0.06);
        padding: 8px;
        border-radius: 10px;
        border: 1px solid rgba(15, 23, 42, 0.08);
        overflow-x: auto;
      }

      .conflicts {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .conflict-card {
        border: 1px solid rgba(239, 68, 68, 0.35);
        background: rgba(239, 68, 68, 0.08);
        padding: 10px 12px;
        border-radius: 12px;
        font-size: 12px;
        color: var(--text);
      }

      .conflict-card .meta {
        color: var(--muted);
        font-size: 11px;
      }

      .conflict-actions {
        display: flex;
        gap: 6px;
        margin-top: 8px;
        flex-wrap: wrap;
      }

      .decision-box {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 12px;
        color: var(--muted);
        background: rgba(255, 255, 255, 0.8);
      }

      @media (max-width: 1200px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="brand">Sci-Tech Course Copilot — Your AI Partner in Project-Based Learning</div>
        <button id="themeToggle" class="theme-toggle" type="button" aria-label="Toggle theme">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <circle cx="12" cy="12" r="4"></circle>
            <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path>
          </svg>
          <span id="themeLabel">Light</span>
        </button>
      </header>

      <main class="grid">
        <section class="panel">
          <div class="panel-header">
            <h2>Chat</h2>
            <div class="subtle">LLM decides entry point · all notifications here</div>
          </div>
          <div id="chatLog" class="chat-log"></div>
          <div id="intakeForm" class="intake-form">
            <div class="form-row">
              <label for="intakeKnowledge">知识点</label>
              <input id="intakeKnowledge" type="text" placeholder="例如：KNN 分类、聚类、数据可视化" />
            </div>
            <div class="form-row">
              <label for="intakeLessonCount">课时（每节 40 分钟）</label>
              <input id="intakeLessonCount" type="number" min="1" value="1" />
              <div class="form-hint">总时长将按课时 × 40 分钟计算</div>
            </div>
            <div class="form-row">
              <label for="intakeAgeGroup">学生年龄段</label>
              <select id="intakeAgeGroup">
                <option value="">请选择</option>
                <option value="小学低">小学低年级</option>
                <option value="小学高">小学高年级</option>
                <option value="初中">初中</option>
                <option value="高中">高中</option>
              </select>
            </div>
            <div class="form-row">
              <label for="intakeClassroom">教室条件</label>
              <select id="intakeClassroom">
                <option value="">请选择</option>
                <option value="常规教室">常规教室</option>
                <option value="机房">机房</option>
                <option value="通识课实验室">通识课实验室</option>
              </select>
            </div>
            <div class="form-actions">
              <button id="intakeSubmit" type="button">开始</button>
            </div>
          </div>
          <div id="chatComposer" class="composer hidden">
            <div class="input-wrap">
              <textarea id="chatInput" placeholder=""></textarea>
              <button id="sendBtn" class="primary send-btn" aria-label="Send">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                  <path d="M3 11l18-8-8 18-2-7-7-3z"></path>
                </svg>
              </button>
            </div>
            <div class="hint">Commands: /select A</div>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <h2>Candidates</h2>
            <div class="subtle" id="stageStatusLabel">No task yet</div>
          </div>
          <div class="stage-track" id="stageTrack"></div>
          <div id="candidateList" class="candidate-list"></div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <h2>Course Plan</h2>
            <div class="subtle" id="planMeta">Assembled from selected candidates</div>
          </div>
          <div id="planBox" class="detail-box"></div>
        </section>
      </main>
    </div>

    <script>
      const themeToggle = document.getElementById("themeToggle");
      const stageStatusLabel = document.getElementById("stageStatusLabel");
      const stageTrack = document.getElementById("stageTrack");
      const chatLog = document.getElementById("chatLog");
      const intakeForm = document.getElementById("intakeForm");
      const intakeSubmit = document.getElementById("intakeSubmit");
      const intakeKnowledge = document.getElementById("intakeKnowledge");
      const intakeLessonCount = document.getElementById("intakeLessonCount");
      const intakeAgeGroup = document.getElementById("intakeAgeGroup");
      const intakeClassroom = document.getElementById("intakeClassroom");
      const chatComposer = document.getElementById("chatComposer");
      const chatInput = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");
      const candidateList = document.getElementById("candidateList");
      const planBox = document.getElementById("planBox");
      const planMeta = document.getElementById("planMeta");
      const STAGES = ["scenario", "driving_question", "question_chain", "activity", "experiment"];

      let sessionId = null;
      let taskId = null;
      let task = null;
      let currentStage = null;
      let artifacts = {};
      let selectedCandidateId = null;
      let eventSource = null;
      let renderedMessageCount = 0;
      let currentPlan = null;
      let pendingAssistant = null;
      let typingQueue = Promise.resolve();
      let thinkingTimeout = null;
      let isBusy = false;

      function scrollChatToBottom() {
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function buildThinkingDots() {
        const dots = document.createElement("div");
        dots.className = "thinking-dots";
        for (let i = 0; i < 3; i += 1) {
          const dot = document.createElement("span");
          dots.appendChild(dot);
        }
        return dots;
      }

      function createMessage(role, text, stage = null, options = {}) {
        const wrap = document.createElement("div");
        wrap.className = `message ${role}`;
        if (options.thinking) wrap.classList.add("thinking");
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = formatMeta(role, stage);
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        if (options.thinking) {
          bubble.classList.add("thinking");
          bubble.appendChild(buildThinkingDots());
        } else {
          bubble.textContent = text || "";
        }
        wrap.appendChild(meta);
        wrap.appendChild(bubble);
        return { wrap, bubble, meta };
      }

      function addChatMessage(role, text, stage = null, options = {}) {
        const message = createMessage(role, text, stage, options);
        chatLog.appendChild(message.wrap);
        scrollChatToBottom();
        return message;
      }

      function formatMeta(role, stage = null) {
        return `${role}${stage ? " · " + stage : ""}`;
      }

      function startThinking(stage = null) {
        if (pendingAssistant) return;
        pendingAssistant = addChatMessage("assistant", "", stage, { thinking: true });
        if (thinkingTimeout) clearTimeout(thinkingTimeout);
        thinkingTimeout = setTimeout(() => {
          clearThinkingBubble();
        }, 12000);
      }

      function consumeThinkingBubble() {
        if (thinkingTimeout) {
          clearTimeout(thinkingTimeout);
          thinkingTimeout = null;
        }
        const target = pendingAssistant;
        pendingAssistant = null;
        return target;
      }

      function clearThinkingBubble() {
        const target = consumeThinkingBubble();
        if (target && target.wrap) {
          target.wrap.remove();
        }
      }

      function typewriter(bubble, text) {
        const content = text || "";
        const length = content.length;
        const chunk = length > 800 ? 6 : length > 400 ? 4 : length > 200 ? 2 : 1;
        bubble.textContent = "";
        return new Promise((resolve) => {
          let index = 0;
          const step = () => {
            bubble.textContent += content.slice(index, index + chunk);
            index += chunk;
            scrollChatToBottom();
            if (index < length) {
              setTimeout(step, 14);
            } else {
              resolve();
            }
          };
          step();
        });
      }

      function queueAssistantMessage(text, stage = null) {
        const target = consumeThinkingBubble() || addChatMessage("assistant", "", stage);
        target.meta.textContent = formatMeta("assistant", stage);
        target.wrap.classList.remove("thinking");
        target.bubble.classList.remove("thinking");
        target.bubble.innerHTML = "";
        typingQueue = typingQueue.then(() => typewriter(target.bubble, text || ""));
      }

      function setBusy(value) {
        isBusy = value;
        renderCandidates();
      }

      function showChatComposer() {
        intakeForm.classList.add("hidden");
        chatComposer.classList.remove("hidden");
        chatInput.placeholder = "";
        chatInput.focus();
      }

      function escapeHtml(text) {
        return String(text)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function renderMarkdown(text) {
        if (!text) return "";
        if (window.marked && typeof marked.parse === "function") {
          marked.setOptions({ breaks: true });
          return marked.parse(text);
        }
        return escapeHtml(text).replace(/\n/g, "<br/>");
      }

      function valueToMarkdown(value) {
        if (value === null || value === undefined) return "";
        if (Array.isArray(value)) {
          return value.map((item, idx) => `${idx + 1}. ${item}`).join("\n");
        }
        if (typeof value === "object") {
          return "```json\n" + JSON.stringify(value, null, 2) + "\n```";
        }
        return String(value);
      }

      function candidateContentToMarkdown(candidate) {
        const content = candidate.content || {};
        if (content.driving_question) {
          let md = `### ${content.driving_question}`;
          if (Array.isArray(content.question_chain) && content.question_chain.length) {
            md += "\n\n**问题链**\n" + content.question_chain.map((q, i) => `${i + 1}. ${q}`).join("\n");
          }
          return md;
        }
        if (Array.isArray(content.question_chain) && content.question_chain.length) {
          return content.question_chain.map((q, i) => `${i + 1}. ${q}`).join("\n");
        }
        if (content.scenario) return content.scenario;
        if (content.activity) return content.activity;
        if (content.experiment) return content.experiment;
        if (typeof content === "string") return content;
        return valueToMarkdown(content);
      }

      function renderStageTrack() {
        stageTrack.innerHTML = "";
        STAGES.forEach((stage) => {
          const pill = document.createElement("div");
          pill.className = "stage-pill";
          if (currentStage === stage) pill.classList.add("active");
          if (task && task.completed_stages && task.completed_stages.includes(stage)) {
            pill.classList.add("done");
          }
          pill.textContent = stage.replace("_", " ");
          stageTrack.appendChild(pill);
        });
      }

      function updateLabels() {
        stageStatusLabel.textContent = task
          ? `Stage: ${task.current_stage || "-"}`
          : "No task yet";
        renderStageTrack();
      }

      function updateFromTask(newTask) {
        task = newTask;
        currentStage = newTask.current_stage;
        artifacts = newTask.artifacts || {};
        updateLabels();
        renderCandidates();
        loadPlan(taskId);
        if (!eventSource || renderedMessageCount === 0) {
          syncMessagesFromTask();
        }
      }

      function renderCandidates() {
        const artifact = artifacts[currentStage];
        if (!artifact || !artifact.candidates || artifact.candidates.length === 0) {
          candidateList.innerHTML = `<div class="subtle">No candidates yet.</div>`;
          return;
        }
        candidateList.innerHTML = "";
        artifact.candidates.forEach((cand) => {
          const card = document.createElement("div");
          card.className = "candidate-card";
          if (cand.id === selectedCandidateId || cand.status === "selected") {
            card.classList.add("selected");
          }
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.style.display = "none";
          meta.textContent = `status: ${cand.status} · alignment: ${cand.alignment_score}`;
          const title = document.createElement("div");
          title.className = "candidate-content markdown";
          title.innerHTML = renderMarkdown(candidateContentToMarkdown(cand));
          const actions = document.createElement("div");
          actions.className = "candidate-actions";
          const selectBtn = document.createElement("button");
          selectBtn.textContent = `Select ${cand.id || ""}`.trim();
          selectBtn.disabled = isBusy;
          selectBtn.onclick = async (evt) => {
            evt.stopPropagation();
            selectedCandidateId = cand.id;
            startThinking(currentStage);
            setBusy(true);
            try {
              await submitAction("select_candidate", { stage: currentStage, candidate_id: cand.id });
            } finally {
              setBusy(false);
            }
          };
          actions.appendChild(selectBtn);
          card.appendChild(title);
          card.appendChild(actions);
          candidateList.appendChild(card);
        });
      }

      function createSection(title, value) {
        const details = document.createElement("details");
        const summary = document.createElement("summary");
        summary.textContent = title;
        const body = document.createElement("div");
        body.className = "section-body";

        let textLength = 0;

        if (Array.isArray(value)) {
          const list = document.createElement("ul");
          value.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = typeof item === "string" ? item : JSON.stringify(item);
            textLength += li.textContent.length;
            list.appendChild(li);
          });
          body.appendChild(list);
        } else if (typeof value === "object" && value !== null) {
          const pre = document.createElement("pre");
          pre.className = "code";
          const text = JSON.stringify(value, null, 2);
          pre.textContent = text;
          textLength = text.length;
          body.appendChild(pre);
        } else {
          const p = document.createElement("p");
          const text = String(value ?? "");
          p.textContent = text;
          textLength = text.length;
          body.appendChild(p);
        }

        details.open = textLength < 200;
        details.appendChild(summary);
        details.appendChild(body);
        return details;
      }

      // Candidate detail view removed; right panel shows assembled course plan.

      // Conflicts view removed from UI.

      function renderPlan() {
        if (!currentPlan || !currentPlan.sections) {
          planBox.innerHTML = `<div class="subtle">No course plan yet.</div>`;
          return;
        }
        const stageLabels = {
          scenario: "场景",
          driving_question: "驱动问题",
          question_chain: "问题链",
          activity: "活动",
          experiment: "实验",
        };
        const blocks = [];
        currentPlan.sections.forEach((section) => {
          const stageTitle = stageLabels[section.stage] || (section.stage || "").replace("_", " ");
          blocks.push(`### ${stageTitle}`);
          if (!section.content) {
            blocks.push("_等待选择_");
            return;
          }
          blocks.push(valueToMarkdown(section.content));
        });
        planBox.innerHTML = `<div class="markdown">${renderMarkdown(blocks.join("\n\n"))}</div>`;
      }

      function appendTaskMessage(message, options = {}) {
        const role = message.role || "assistant";
        const text = message.text || "";
        const stage = message.stage || null;
        if (role === "assistant" && options.stream !== false) {
          queueAssistantMessage(text, stage);
        } else {
          clearThinkingBubble();
          addChatMessage(role, text, stage);
        }
        renderedMessageCount += 1;
      }

      function syncMessagesFromTask() {
        if (!task || !Array.isArray(task.messages)) return;
        for (let i = renderedMessageCount; i < task.messages.length; i += 1) {
          appendTaskMessage(task.messages[i], { stream: false });
        }
      }

      async function submitAction(actionType, payload) {
        if (!taskId || !currentStage) {
          clearThinkingBubble();
          setBusy(false);
          addChatMessage("system", "No active task or stage.");
          return;
        }
        const response = await fetch(`/api/tasks/${taskId}/action`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action_type: actionType, payload }),
        });
        if (!response.ok) {
          const msg = await response.text();
          clearThinkingBubble();
          setBusy(false);
          addChatMessage("system", `Action error: ${msg}`);
          return;
        }
        const data = await response.json();
        if (data.task) updateFromTask(data.task);
      }

      async function loadTask(taskIdValue) {
        const response = await fetch(`/api/tasks/${taskIdValue}`);
        if (!response.ok) {
          const msg = await response.text();
          addChatMessage("system", `Load task error: ${msg}`);
          return;
        }
        const data = await response.json();
        updateFromTask(data);
      }

      async function loadPlan(taskIdValue) {
        if (!taskIdValue) return;
        const response = await fetch(`/api/tasks/${taskIdValue}/plan`);
        if (!response.ok) {
          const msg = await response.text();
          addChatMessage("system", `Plan error: ${msg}`);
          return;
        }
        currentPlan = await response.json();
        renderPlan();
      }

      function connectSse(taskIdValue) {
        if (eventSource) eventSource.close();
        eventSource = new EventSource(`/api/tasks/${taskIdValue}/events`);
        eventSource.addEventListener("candidates", (evt) => {
          const payload = JSON.parse(evt.data);
          const data = payload.data || payload;
          if (data.stage) {
            artifacts[data.stage] = {
              stage_type: data.stage,
              candidates: data.candidates || [],
            };
            currentStage = data.stage;
            updateLabels();
            renderCandidates();
            loadPlan(taskId);
            setBusy(false);
            clearThinkingBubble();
          }
        });
        eventSource.addEventListener("task_updated", (evt) => {
          const payload = JSON.parse(evt.data);
          const data = payload.data || payload;
          if (data.task_id) updateFromTask(data);
        });
        eventSource.addEventListener("message", (evt) => {
          const payload = JSON.parse(evt.data);
          const data = payload.data || payload;
          appendTaskMessage({ role: data.role, text: data.text, stage: data.stage });
        });
        eventSource.addEventListener("error", (evt) => {
          clearThinkingBubble();
          setBusy(false);
          addChatMessage("system", "SSE connection error.");
        });
      }

      async function sendChatMessage(text, intake = null) {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            session_id: sessionId,
            message: text ?? "",
            task_id: taskId,
            intake: intake || undefined,
          }),
        });
        if (!response.ok) {
          const msg = await response.text();
          clearThinkingBubble();
          setBusy(false);
          addChatMessage("system", `Chat error: ${msg}`);
          return;
        }
        const data = await response.json();
        sessionId = data.session_id;
        updateLabels();
        if (data.assistant_message) {
          queueAssistantMessage(data.assistant_message, null);
        } else {
          clearThinkingBubble();
        }
        if (data.status === "ready" && data.task_id) {
          taskId = data.task_id;
          renderedMessageCount = 0;
          updateLabels();
          await loadTask(taskId);
          connectSse(taskId);
        }
      }

      function parseCommand(text) {
        const trimmed = text.trim();
        const lower = trimmed.toLowerCase();
        if (lower.startsWith("/select")) {
          const parts = trimmed.split(/\s+/);
          const id = parts[1] ? parts[1].toUpperCase() : null;
          if (id) return { action: "select_candidate", candidate_id: id };
        }
        if (/^[abc]$/i.test(trimmed) && hasUnresolvedConflict()) {
          return { action: "resolve_conflict", option: trimmed.toUpperCase() };
        }
        return null;
      }

      function hasUnresolvedConflict() {
        if (!task || !currentStage || !task.conflicts) return false;
        const conflicts = task.conflicts[currentStage] || [];
        return conflicts.some((conflict) => !conflict.resolved);
      }

      async function handleSend() {
        const text = chatInput.value.trim();
        if (!text) return;
        chatInput.value = "";
        if (chatInput.placeholder) {
          chatInput.placeholder = "";
        }
        addChatMessage("user", text, currentStage);
        startThinking(currentStage);

        if (!taskId) {
          await sendChatMessage(text);
          return;
        }

        const command = parseCommand(text);
        if (command) {
          if (command.action === "select_candidate") {
            await submitAction(command.action, { stage: currentStage, candidate_id: command.candidate_id });
          } else if (command.action === "resolve_conflict") {
            await submitAction(command.action, { stage: currentStage, option: command.option });
          } else {
            await submitAction(command.action, { stage: currentStage });
          }
          return;
        }

        await submitAction("provide_feedback", { stage: currentStage, feedback: text });
      }

      sendBtn.onclick = handleSend;
      chatInput.addEventListener("keydown", (evt) => {
        if (evt.key === "Enter" && !evt.shiftKey) {
          evt.preventDefault();
          handleSend();
        }
      });

      intakeSubmit.onclick = async () => {
        const knowledge_point = intakeKnowledge.value.trim();
        const lesson_count = parseInt(intakeLessonCount.value || "1", 10);
        const age_group = intakeAgeGroup.value.trim();
        const classroom_type = intakeClassroom.value.trim();
        if (!knowledge_point || !age_group || !classroom_type) {
          addChatMessage("system", "请填写完整的知识点、年龄段与教室条件。");
          return;
        }
        const intake = {
          knowledge_point,
          lesson_count: Number.isNaN(lesson_count) ? 1 : Math.max(1, lesson_count),
          age_group,
          classroom_type,
        };
        showChatComposer();
        startThinking(null);
        await sendChatMessage("", intake);
      };

      function applyTheme(theme) {
        document.body.dataset.theme = theme;
        const isDark = theme === "dark";
        themeToggle.innerHTML = isDark
          ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 12.8A9 9 0 1111.2 3a7 7 0 109.8 9.8z"></path></svg><span id="themeLabel">Dark</span>`
          : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path></svg><span id="themeLabel">Light</span>`;
        const label = themeToggle.querySelector("#themeLabel");
        if (label) {
          label.textContent = isDark ? "Dark" : "Light";
        }
      }

      themeToggle.onclick = () => {
        const next = document.body.dataset.theme === "dark" ? "light" : "dark";
        localStorage.setItem("pbl_theme", next);
        applyTheme(next);
      };

      const savedTheme = localStorage.getItem("pbl_theme") || "light";
      applyTheme(savedTheme);

      addChatMessage("system", "请先填写左侧课程信息表单。");
      updateLabels();
    </script>
  </body>
</html>
